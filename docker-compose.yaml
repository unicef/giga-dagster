x-common-config: &common-config
  init: true
  restart: unless-stopped
  networks:
    - giga-dataops

x-dagster-common-config: &dagster-common-config
  <<: *common-config
  env_file: ./dagster/.env
  build: ./dagster
  image: unicef/giga-dataops-platform/dagster
  environment:
    DAGSTER_HOME: /app

x-spark-common-config: &spark-common-config
  <<: *common-config
  user: "1001:1001"
  image: unicef/giga-dataops-platform/spark
  env_file: ./dagster/.env

volumes:
  dagster-storage:

networks:
  giga-dataops:
    external: true

services:
  dagster-storage:
    <<: *common-config
    image: bitnami/postgresql:14
    env_file: ./dagster/.env
    volumes:
      - dagster-storage:/bitnami/postgresql

  dagster-webserver:
    <<: *dagster-common-config
    volumes:
      - ./dagster:/app
      - ./dagster/.tmp/warehouse:/opt/spark/warehouse
    depends_on:
      - dagster-storage
    ports:
      - "3001:3002"

  dagster-webserver-readonly:
    <<: *dagster-common-config
    command:
      - "dagster-webserver"
      - "-h"
      - "0.0.0.0"
      - "-p"
      - "3003"
      - "--read-only"
    volumes:
      - ./dagster:/app
    depends_on:
      - dagster-storage
    ports:
      - "3003:3003"

  spark-master:
    <<: *spark-common-config
    build:
      context: .
      target: master
      dockerfile: spark/Dockerfile
    environment:
      SPARK_MODE: master
      SPARK_MASTER_PORT: 7077
      SPARK_MASTER_WEBUI_PORT: 8070
      THRIFT_PORT: 10000
    ports:
      - "8070:8070"
      - "10000:10000"

  spark-worker:
    <<: *spark-common-config
    build:
      context: .
      target: base
      dockerfile: spark/Dockerfile
    environment:
      SPARK_MODE: worker
      SPARK_MASTER_URL: spark://spark-master:7077
      SPARK_WORKER_CORES: 1
      SPARK_WORKER_MEMORY: 1024M
      PYTHONPATH: /opt/bitnami/spark/app
    deploy:
      mode: replicated
      replicas: 3
      endpoint_mode: dnsrr
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    working_dir: /opt/bitnami/spark/app
    volumes:
      - ./dagster:/opt/bitnami/spark/app

  #  authproxy:
  #    <<: *common-config
  #    build: ./authproxy
  #    image: unicef/giga-dataops-platform/dagster-authproxy
  #    env_file: ./authproxy/.env
  #    volumes:
  #      - ./authproxy:/app
  #    ports:
  #      - "3001:3001"
