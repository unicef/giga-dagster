x-common-config: &common-config
  init: true
  restart: on-failure
  networks:
    - dagster-giga-network

services:
  dagster-storage:
    <<: *common-config
    image: bitnami/postgresql:14
    env_file: 
      - .env
    volumes:
      - dagster-storage:/bitnami/postgresql
    environment:
      POSTGRES_USER: ${DAGSTER_POSTGRES_USER}
      POSTGRES_PASSWORD: ${DAGSTER_POSTGRES_PASSWORD}
      POSTGRES_DB: ${DAGSTER_POSTGRES_DB}

  dagster-webserver:
    <<: *common-config
    command: ["dagster-webserver", "-h", "0.0.0.0", "-p", "3000", "-w", "workspace.yaml"]  
    build:
      context: .
      dockerfile: dagster/Dockerfile
    image: unicef/giga-dataops-platform/dagster-pipelines
    env_file: 
      - .env
    environment:
      ENVIRONMENT: ${ENVIRONMENT}
      DAGSTER_CURRENT_IMAGE: "dagster-pipelines-image"
      DAGSTER_POSTGRES_USER: ${DAGSTER_POSTGRES_USER}
      DAGSTER_POSTGRES_PASSWORD: ${DAGSTER_POSTGRES_PASSWORD}
      DAGSTER_POSTGRES_DB: ${DAGSTER_POSTGRES_DB}
      DAGSTER_POSTGRES_HOST: dagster-storage
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/io_manager_storage:/tmp/io_manager_storage
    depends_on:
      - dagster-storage
      - dagster-pipelines
  
  dagster-pipelines:
    <<: *common-config
    build:
      context: .
      dockerfile: dagster/Dockerfile
    image: unicef/giga-dataops-platform/dagster-pipelines
    env_file: 
      - .env
    expose:
      - 4000
    environment:
      ENVIRONMENT: ${ENVIRONMENT}
      DAGSTER_CURRENT_IMAGE: "unicef/giga-dataops-platform/dagster-pipelines"
      DAGSTER_POSTGRES_USER: ${DAGSTER_POSTGRES_USER}
      DAGSTER_POSTGRES_PASSWORD: ${DAGSTER_POSTGRES_PASSWORD}
      DAGSTER_POSTGRES_DB: ${DAGSTER_POSTGRES_DB}
      DAGSTER_POSTGRES_HOST: dagster-storage
    depends_on:
      - dagster-storage
  
  dagster-daemon:
    <<: *common-config
    build:
      context: .
      dockerfile: dagster/Dockerfile
    image: unicef/giga-dataops-platform/dagster-pipelines
    command: ["dagster-daemon", "run"]
    env_file: 
      - .env
    environment:
      ENVIRONMENT: ${ENVIRONMENT}
      DAGSTER_CURRENT_IMAGE: "dagster-pipelines-image"
      DAGSTER_POSTGRES_USER: ${DAGSTER_POSTGRES_USER}
      DAGSTER_POSTGRES_PASSWORD: ${DAGSTER_POSTGRES_PASSWORD}
      DAGSTER_POSTGRES_DB: ${DAGSTER_POSTGRES_DB}
      DAGSTER_POSTGRES_HOST: dagster-storage
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/io_manager_storage:/tmp/io_manager_storage
    depends_on:
      - dagster-storage
      - dagster-pipelines

  authproxy:
    <<: *common-config
    build: ./authproxy
    image: unicef/giga-dataops-platform/dagster-authproxy
    env_file:
      - .env
    volumes:
      - ./authproxy:/app
    ports:
      - "3001:3001"

networks:
  dagster-giga-network:
    name: dagster-giga-network
    driver: bridge
  
volumes:
  dagster-storage:
    driver: local
