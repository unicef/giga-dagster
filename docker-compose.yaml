x-common-config: &common-config
  init: true
  restart: on-failure

services:
  dagster-storage:
    <<: *common-config
    image: bitnami/postgresql:14
    env_file: ./dagster/.env
    volumes:
      - dagster-storage:/bitnami/postgresql

  dagster-pipelines:
    <<: *common-config
    build: ./dagster
    image: ${DAGSTER_CURRENT_IMAGE}
    env_file: ./dagster/.env
    environment:
      ENVIRONMENT: ${PYTHON_ENV}
      DAGSTER_CURRENT_IMAGE: ${DAGSTER_CURRENT_IMAGE}
      DAGSTER_POSTGRES_USER: ${POSTGRESQL_USERNAME}
      DAGSTER_POSTGRES_PASSWORD: ${POSTGRESQL_PASSWORD}
      DAGSTER_POSTGRES_DB: ${POSTGRESQL_DATABASE}
      DAGSTER_POSTGRES_HOST: dagster-storage
    volumes:
      - ./dagster:/app
    depends_on:
      - dagster-storage

  dagster-webserver:
    <<: *common-config
    command:
      - "dagster-webserver"
      - "-h"
      - "0.0.0.0"
      - "-p"
      - "3002"
      - "-w"
      - "workspace.yaml"
    build: ./dagster
    image: ${DAGSTER_CURRENT_IMAGE}
    env_file: ./dagster/.env
    environment:
      ENVIRONMENT: ${PYTHON_ENV}
      DAGSTER_CURRENT_IMAGE: ${DAGSTER_CURRENT_IMAGE}
      DAGSTER_POSTGRES_USER: ${POSTGRESQL_USERNAME}
      DAGSTER_POSTGRES_PASSWORD: ${POSTGRESQL_PASSWORD}
      DAGSTER_POSTGRES_DB: ${POSTGRESQL_DATABASE}
      DAGSTER_POSTGRES_HOST: dagster-storage
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/io_manager_storage:/tmp/io_manager_storage
      - ./dagster:/app
    depends_on:
      - dagster-storage
      - dagster-pipelines
  
  dagster-daemon:
    <<: *common-config
    build: ./dagster
    image: ${DAGSTER_CURRENT_IMAGE}
    command:
      - "dagster-daemon"
      - "run"
      - "--grpc-host"
      - "dagster-pipelines"
      - "--grpc-port"
      - "4000"
    env_file: ./dagster/.env
    environment:
      ENVIRONMENT: ${PYTHON_ENV}
      DAGSTER_CURRENT_IMAGE: ${DAGSTER_CURRENT_IMAGE}
      DAGSTER_POSTGRES_USER: ${POSTGRESQL_USERNAME}
      DAGSTER_POSTGRES_PASSWORD: ${POSTGRESQL_PASSWORD}
      DAGSTER_POSTGRES_DB: ${POSTGRESQL_DATABASE}
      DAGSTER_POSTGRES_HOST: dagster-storage
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/io_manager_storage:/tmp/io_manager_storage
      - ./dagster:/app
    depends_on:
      - dagster-storage
      - dagster-pipelines

  authproxy:
    <<: *common-config
    build: ./authproxy
    image: unicef/giga-dataops-platform/dagster-authproxy
    env_file: ./authproxy/.env
    volumes:
      - ./authproxy:/app
    ports:
      - "3001:3001"

volumes:
  dagster-storage:
